#!/bin/sh

# this script writes a configuration file to stdout

echo '(* This file is generated by ./gen_buildInfo *)'

share='Filename.concat prefix "share"'
if [ "${PREFIX:-}" ]; then
        prefix="\"$PREFIX\"";
elif opam config var prefix >/dev/null 2>&1; then
        prefix="\"$(opam config var prefix)\""
elif type ocamlc >/dev/null 2>&1; then
        x="$(type ocamlc)"
        prefix="\"$(dirname "$(dirname "${x#ocamlc is }")")\""
else
        prefix='opamVar prefix "/usr/local"'
        share='opamVar share (Filename.concat prefix "share")'
        cat <<'EOF'
let opamVar name default =
  try
    let (ic, _, _) as cs =
      let env = Unix.environment () in
      Unix.open_process_full ("opam config var " ^ name) env
    in
    let res = input_line ic in
    ignore (Unix.close_process_full cs);
    res
  with _ -> default
EOF
fi

cat <<EOF
let prefix = $prefix
let share = $share
EOF
